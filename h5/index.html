<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <!-- 安全头：防止点击劫持 -->
    <meta http-equiv="X-Frame-Options" content="DENY">
    <!-- 安全头：内容安全策略 -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https: data:; font-src 'self' data:; connect-src 'self' https:; frame-ancestors 'none';">
    <!-- 安全头：XSS防护 -->
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <!-- 安全头：禁止MIME类型嗅探 -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- 安全头：Referrer策略 -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>TECHSPACE短视频</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="page" id="app">
        <!-- 顶部Tab -->
        <header class="header">
            <div class="header-btn"></div>
            <div class="tabs" id="homeTabs">
                <div class="tab-item active" data-tab="recommend" onclick="location.href='feed.html?tab=recommend'">推荐</div>
                <div class="tab-item" data-tab="hot" onclick="location.href='feed.html?tab=hot'">热门</div>
                <div class="tab-item" data-tab="near">附近</div>
            </div>
            <div class="header-btn" onclick="location.href='search.html'">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="#fff">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                </svg>
            </div>
        </header>

        <!-- 视频列表内容 -->
        <div class="content" style="padding-top: 50px;">
            <!-- 推荐列表 -->
            <div class="tab-content active" id="recommendList">
                <div class="video-grid" id="recommendGrid">
                    <!-- 视频卡片由JS动态生成 -->
                </div>
                <div class="loading" id="recommendLoading">
                    <div class="loading-spinner"></div>
                </div>
            </div>

            <!-- 热门列表 -->
            <div class="tab-content" id="hotList" style="display:none;">
                <div class="video-grid" id="hotGrid"></div>
            </div>

            <!-- 附近列表 -->
            <div class="tab-content" id="nearList" style="display:none;">
                <div class="video-grid" id="nearGrid"></div>
            </div>
        </div>

        <!-- 底部导航 -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item active">
                <div class="icon">
                    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                </div>
                <span>首页</span>
            </a>
            <a href="follow.html" class="nav-item">
                <div class="icon">
                    <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                </div>
                <span>关注</span>
            </a>
            <div class="nav-publish" onclick="location.href='publish.html'">
                <svg viewBox="0 0 24 24" fill="#000"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </div>
            <a href="message.html" class="nav-item">
                <div class="icon">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
                </div>
                <span>消息</span>
            </a>
            <a href="me.html" class="nav-item">
                <div class="icon">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <span>我的</span>
            </a>
        </nav>
    </div>

    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        // XSS防护：HTML转义函数
        const escapeHtml = (str) => App.escapeHtml ? App.escapeHtml(str) : String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

        // 初始化首页
        document.addEventListener('DOMContentLoaded', function() {
            // Tab切换
            const tabs = document.querySelectorAll('#homeTabs .tab-item');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;

                    // 热门跳转到全屏视频页
                    if (tabName === 'hot') {
                        return; // onclick已处理跳转
                    }

                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                    document.getElementById(tabName + 'List').style.display = 'block';

                    // 加载对应数据
                    if (tabName === 'recommend') {
                        loadRecommendVideos();
                    } else if (tabName === 'near') {
                        loadNearVideos();
                    }
                });
            });

            // 加载推荐视频
            loadRecommendVideos();
        });

        // 加载推荐视频
        function loadRecommendVideos() {
            const grid = document.getElementById('recommendGrid');
            // 模拟数据
            const videos = getDemoVideos();
            renderVideoGrid(grid, videos);
        }

        // 加载热门视频
        function loadHotVideos() {
            const grid = document.getElementById('hotGrid');
            const videos = getDemoVideos();
            renderVideoGrid(grid, videos);
        }

        // 加载附近视频
        function loadNearVideos() {
            const grid = document.getElementById('nearGrid');
            const videos = getDemoVideos();
            renderVideoGrid(grid, videos);
        }

        // 渲染视频列表
        function renderVideoGrid(container, videos) {
            container.innerHTML = videos.map(v => `
                <div class="video-card" onclick="location.href='play.html?id=${parseInt(v.id)}'">
                    <img class="cover" src="${escapeHtml(v.thumb)}" alt="">
                    <div class="info">
                        <div class="author">
                            <img class="avatar" src="${escapeHtml(v.avatar)}" alt="">
                            <span class="name">@${escapeHtml(v.nickname)}</span>
                        </div>
                        <div class="desc">${escapeHtml(v.title)}</div>
                    </div>
                    <div class="stats">
                        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        ${formatNumber(v.likes)}
                    </div>
                </div>
            `).join('');

            document.getElementById('recommendLoading').style.display = 'none';
        }

        // 获取演示数据
        function getDemoVideos() {
            const demos = [];
            for (let i = 1; i <= 10; i++) {
                demos.push({
                    id: i,
                    title: '这是一个很棒的短视频 #热门',
                    thumb: 'https://picsum.photos/300/400?random=' + i,
                    avatar: 'https://i.pravatar.cc/100?img=' + i,
                    nickname: '用户' + i,
                    likes: Math.floor(Math.random() * 10000)
                });
            }
            return demos;
        }

        // 数字格式化
        function formatNumber(num) {
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'w';
            }
            return num;
        }
    </script>
</body>
</html>
